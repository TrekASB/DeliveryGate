<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeliveryGate</title>

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- jsPDF for PDF-rapport -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; --bg2:#f9fafb; }
    body { font-family: system-ui, Segoe UI, Arial; margin:0; color:var(--t); background:var(--bg); }
    header { padding:14px 18px; border-bottom:1px solid var(--b); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header .pill { font-size:12px; color:var(--m); background:var(--bg2); border:1px solid var(--b); padding:4px 8px; border-radius:999px; }
    .brand { display:flex; align-items:center; gap:10px; margin-right:6px; }
    .brand img { height:22px; width:auto; display:block; }
    .brand .title { display:flex; flex-direction:column; line-height:1.1; }
    .brand .title b { font-size:14px; }
    .brand .title span { font-size:12px; color:var(--m); }

    main { padding:16px 18px; display:grid; gap:16px; grid-template-columns: 1.2fr 0.8fr; }
    @media (max-width: 1000px){ main{ grid-template-columns:1fr; } }

    .card { border:1px solid var(--b); border-radius:12px; overflow:hidden; background:#fff; }
    .card h2 { font-size:14px; margin:0; padding:12px 14px; border-bottom:1px solid var(--b); background:var(--bg2); }
    .card .content { padding:14px; display:grid; gap:12px; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:var(--m); display:block; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:10px; border:1px solid var(--b); border-radius:10px; font-size:13px; }
    textarea { min-height:88px; resize:vertical; }
    .btn { padding:10px 12px; border:1px solid var(--b); border-radius:10px; background:var(--bg2); cursor:pointer; font-size:13px; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn.danger { background:#fff; border-color:#ef4444; color:#b91c1c; }

    .warn { border:1px solid #f59e0b55; background:#f59e0b10; padding:10px; border-radius:10px; font-size:12px; color:#92400e; }
    .err { border:1px solid #ef444455; background:#ef444410; padding:10px; border-radius:10px; font-size:12px; color:#991b1b; }
    .muted { color:var(--m); font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--b); vertical-align:top; }
    th { text-align:left; color:var(--m); font-weight:600; font-size:12px; }

    .tag { display:inline-block; font-size:12px; padding:2px 8px; border:1px solid var(--b); border-radius:999px; background:var(--bg2); margin-right:6px; }
    .ok { border-color:#10b98155; background:#10b98115; }
    .no { border-color:#ef444455; background:#ef444415; }
    .na { border-color:#f59e0b55; background:#f59e0b15; }

    .filelist { border:1px solid var(--b); border-radius:12px; overflow:hidden; }
    .filelist .head { background:var(--bg2); border-bottom:1px solid var(--b); padding:10px 12px; font-size:12px; color:var(--m); display:flex; justify-content:space-between; }
    .filelist ul { list-style:none; margin:0; padding:0; max-height:220px; overflow:auto; }
    .filelist li { padding:10px 12px; border-bottom:1px solid var(--b); font-size:13px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .filelist li:last-child { border-bottom:none; }
    .filelist .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 78%; }
    .filelist .mini { font-size:12px; color:var(--m); }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img src="./norconsult-logo-black.png" alt="Norconsult" />
    <div class="title">
      <b>DeliveryGate</b>
      <span>QA / Release gate (prim√¶rt 3D)</span>
    </div>
  </div>

  <span class="pill" id="pillProject">Prosjekt: ‚Äì</span>
  <span class="pill" id="pillUser">Bruker: ‚Äì</span>
  <span class="pill" id="pillSelection">Filer i scope: 0</span>
  <span class="pill" id="pillMode">Mode: ‚Äì</span>
</header>

<main>
  <section class="card">
    <h2>Scope (3D lastede modeller) + workflow</h2>
    <div class="content">

      <div class="warn">
        <b>Hvordan velger du ‚Äúscope‚Äù i 3D:</b>
        <ul style="margin:6px 0 0 16px; padding:0;">
          <li>Trykk <b>‚ÄúBruk lastede modeller (3D)‚Äù</b> for √• hente alle modeller som er lastet i viewer.</li>
          <li>Eller klikk et objekt i 3D ‚Äì da pr√∏ver DeliveryGate √• finne filen modellen kommer fra.</li>
        </ul>
        <b>Regelsett:</b>
        <ul style="margin:6px 0 0 16px; padding:0;">
          <li>Sidemannskontroll kan ikke signeres av samme person som signerte egenkontroll.</li>
          <li>Godkjenning kan ikke signeres f√∏r kollisjonskontroll er <b>OK</b>.</li>
          <li>Ved <b>IKKE OK</b> m√• du legge inn BCF Topic-lenke/ID.</li>
        </ul>
      </div>

      <div class="row">
        <button class="btn" id="btnUseLoaded3D">Bruk lastede modeller (3D)</button>
        <button class="btn" id="btnUse3DSelection">Bruk valgt(e) objekt i 3D</button>
        <button class="btn primary" id="btnStartForAll">Start kontroll (opprett workflow for alle i scope)</button>
        <button class="btn" id="btnReportJsonAll">Release-ready JSON (alle i scope)</button>
        <button class="btn" id="btnReportPdfActive">QA-PDF (aktiv fil)</button>
      </div>

      <div class="filelist">
        <div class="head">
          <span>Scope-filer</span>
          <span class="mini" id="activeHint">Aktiv: ‚Äì</span>
        </div>
        <ul id="fileUl">
          <li class="muted">Trykk ‚ÄúBruk lastede modeller (3D)‚Äù for √• fylle listen.</li>
        </ul>
      </div>

      <div class="card" style="border-radius:12px;">
        <h2>Workflow-logg (aktiv fil + versjon)</h2>
        <div class="content">
          <div class="row">
            <button class="btn" id="btnNewActive">Start ny workflow (aktiv fil)</button>
            <button class="btn" id="btnExportActive">Eksporter workflow JSON (aktiv fil)</button>
            <button class="btn danger" id="btnClearActive">Slett workflow (aktiv fil)</button>
          </div>

          <div class="muted">N√∏kkel: <span class="mono" id="keyLabel">‚Äì</span></div>

          <table>
            <thead>
              <tr>
                <th>Steg</th><th>Status</th><th>Utf√∏rt av</th><th>Tidspunkt</th><th>Kommentar</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="5" class="muted">Velg en aktiv fil i dropdown eller klikk p√• en fil i listen.</td></tr>
            </tbody>
          </table>

          <div id="ruleMsg" class="err" style="display:none"></div>
        </div>
      </div>

    </div>
  </section>

  <aside class="card">
    <h2>Registrer kontroll</h2>
    <div class="content">

      <div>
        <label for="activeFileSelect">Aktiv fil (fra scope)</label>
        <select id="activeFileSelect"></select>
        <div class="muted">Signering gjelder alltid ‚Äúaktiv fil‚Äù.</div>
      </div>

      <div class="row" style="width:100%">
        <div style="flex:1; min-width:220px">
          <label for="step">Steg</label>
          <select id="step">
            <option value="egenkontroll">Egenkontroll</option>
            <option value="sidemann">Sidemannskontroll</option>
            <option value="kollisjon">Kollisjonskontroll</option>
            <option value="godkjenning">Godkjenning</option>
          </select>
        </div>

        <div style="flex:1; min-width:220px">
          <label for="result">Resultat</label>
          <select id="result">
            <option value="OK">OK</option>
            <option value="IKKE_OK">IKKE OK</option>
            <option value="N/A">N/A</option>
          </select>
        </div>
      </div>

      <div id="bcfWrap" style="display:none">
        <label for="bcfLink">BCF Topic (p√•krevd ved IKKE OK)</label>
        <input id="bcfLink" placeholder="URL eller Topic-ID (f.eks. BCF-1234)" />
      </div>

      <div>
        <label for="comment">Kommentar / funn</label>
        <textarea id="comment" placeholder="Hva er sjekket og ev. avvik..."></textarea>
      </div>

      <div class="row">
        <button class="btn primary" id="btnSign">Sign√©r steg (aktiv fil)</button>
        <button class="btn" id="btnToken">Hent accessToken (valgfritt)</button>
      </div>

      <div class="muted" id="tokenInfo" style="display:none"></div>

    </div>
  </aside>
</main>

<script>
  let API = null;

  const STEPS = [
    { key: "egenkontroll", label: "Egenkontroll" },
    { key: "sidemann", label: "Sidemannskontroll" },
    { key: "kollisjon", label: "Kollisjonskontroll" },
    { key: "godkjenning", label: "Godkjenning" }
  ];

  const state = {
    project: null,
    user: null,
    selectedFiles: [],     // scope: [{id,name,versionId}]
    activeFileKey: null,   // `${id}::${versionId||noVersion}`
    activeFile: null,
    workflow: null,
    accessToken: null,
    runtimeMode: "unknown" // viewer/project/unknown
  };

  function nowISO(){ return new Date().toISOString(); }
  function safeUserDisplay(u){ return u?.name || u?.displayName || u?.email || u?.userName || "Ukjent"; }

  function buildStorageKey(projectId, fileId, versionId){
    return `deliverygate::${projectId}::${fileId}::${versionId || "noVersion"}`;
  }
  function loadWorkflow(key){
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }
  function saveWorkflow(key, wf){ localStorage.setItem(key, JSON.stringify(wf)); }

  function newWorkflowFor(fileObj){
    return {
      schema: "deliverygate-workflow-v4",
      createdAt: nowISO(),
      createdBy: safeUserDisplay(state.user),
      fileMeta: {
        projectId: state.project.id,
        projectName: state.project.name,
        fileId: fileObj.id,
        versionId: fileObj.versionId || null,
        name: fileObj.name
      },
      steps: { egenkontroll:null, sidemann:null, kollisjon:null, godkjenning:null },
      history: []
    };
  }

  function isOk(stepObj){ return stepObj && stepObj.result === "OK"; }

  function statusTag(result){
    if (result === "OK") return `<span class="tag ok">OK</span>`;
    if (result === "IKKE_OK") return `<span class="tag no">IKKE OK</span>`;
    return `<span class="tag na">N/A</span>`;
  }

  function showRuleError(msg){
    const el = document.getElementById("ruleMsg");
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearRuleError(){
    const el = document.getElementById("ruleMsg");
    el.style.display = "none";
    el.textContent = "";
  }

  function toggleBcfUI(){
    const res = document.getElementById("result").value;
    document.getElementById("bcfWrap").style.display = (res === "IKKE_OK") ? "block" : "none";
  }

  function validateRules(stepKey, result, bcfLink){
    if (result === "IKKE_OK" && (!bcfLink || !bcfLink.trim())){
      return "Resultat = IKKE OK krever BCF Topic-lenke/ID.";
    }

    const wf = state.workflow;
    const currentUser = safeUserDisplay(state.user);

    if (stepKey === "sidemann"){
      const egen = wf?.steps?.egenkontroll;
      if (egen?.by && egen.by === currentUser){
        return "Regelbrudd: Sidemannskontroll kan ikke signeres av samme person som egenkontroll.";
      }
    }

    if (stepKey === "godkjenning"){
      const koll = wf?.steps?.kollisjon;
      if (!isOk(koll)){
        return "Regelbrudd: Godkjenning kan ikke signeres f√∏r Kollisjonskontroll = OK.";
      }
    }
    return null;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function downloadText(filename, text, mime="application/json"){
    const blob = new Blob([text], { type: mime });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename.replace(/[^\w.\-() ]+/g, "_");
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---------- Scope handling ----------

  function setSelectedFiles(files){
    const map = new Map();
    for (const f of (files || [])){
      if (!f?.id) continue;
      const vid = f.versionId || null;
      const k = `${f.id}::${vid || "noVersion"}`;
      map.set(k, { id: f.id, name: f.name || "Ukjent fil", versionId: vid });
    }
    state.selectedFiles = Array.from(map.values());

    document.getElementById("pillSelection").textContent = `Filer i scope: ${state.selectedFiles.length}`;

    const sel = document.getElementById("activeFileSelect");
    sel.innerHTML = "";

    if (!state.selectedFiles.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "‚Äî ingen filer i scope ‚Äî";
      sel.appendChild(opt);
      state.activeFile = null;
      state.activeFileKey = null;
      state.workflow = null;
      renderFileList();
      renderActive();
      return;
    }

    for (const f of state.selectedFiles){
      const opt = document.createElement("option");
      opt.value = `${f.id}::${f.versionId || "noVersion"}`;
      opt.textContent = `${f.name}${f.versionId ? "" : " (ingen versionId)"}`;
      sel.appendChild(opt);
    }

    const desired = state.activeFileKey || sel.options[0].value;
    sel.value = Array.from(sel.options).some(o => o.value === desired) ? desired : sel.options[0].value;
    onActiveChanged();
    renderFileList();
  }

  function onActiveChanged(){
    const sel = document.getElementById("activeFileSelect");
    const val = sel.value;
    state.activeFileKey = val || null;

    const [id, vidRaw] = (val || "").split("::");
    const vid = (vidRaw === "noVersion") ? null : vidRaw;

    state.activeFile = state.selectedFiles.find(f => f.id === id && ((f.versionId || null) === (vid || null))) || null;

    if (state.activeFile){
      const key = buildStorageKey(state.project?.id ?? "noProject", state.activeFile.id, state.activeFile.versionId);
      state.workflow = loadWorkflow(key);
      document.getElementById("activeHint").textContent = `Aktiv: ${state.activeFile.name}`;
      document.getElementById("keyLabel").textContent = key;
    } else {
      state.workflow = null;
      document.getElementById("activeHint").textContent = "Aktiv: ‚Äì";
      document.getElementById("keyLabel").textContent = "‚Äì";
    }

    clearRuleError();
    renderActive();
    renderFileList();
  }

  function renderFileList(){
    const ul = document.getElementById("fileUl");
    ul.innerHTML = "";

    if (!state.selectedFiles.length){
      ul.innerHTML = `<li class="muted">Ingen filer i scope. Trykk ‚ÄúBruk lastede modeller (3D)‚Äù.</li>`;
      return;
    }

    for (const f of state.selectedFiles){
      const li = document.createElement("li");
      const isActive = state.activeFile && f.id === state.activeFile.id && (f.versionId || null) === (state.activeFile.versionId || null);
      const key = buildStorageKey(state.project?.id ?? "noProject", f.id, f.versionId);
      const wf = loadWorkflow(key);
      const ready = wf?.steps?.godkjenning && isOk(wf?.steps?.kollisjon);

      li.innerHTML = `
        <div class="name" title="${escapeHtml(f.name)}">${isActive ? "‚ñ∂ " : ""}${escapeHtml(f.name)}</div>
        <div class="mini">${ready ? "‚úÖ" : (wf ? "üìù" : "‚Äî")}</div>
      `;
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        document.getElementById("activeFileSelect").value = `${f.id}::${f.versionId || "noVersion"}`;
        onActiveChanged();
      });
      ul.appendChild(li);
    }
  }

  function renderActive(){
    document.getElementById("pillProject").textContent = `Prosjekt: ${state.project?.name ?? "‚Äì"}`;
    document.getElementById("pillUser").textContent = `Bruker: ${safeUserDisplay(state.user)}`;
    document.getElementById("pillMode").textContent = `Mode: ${state.runtimeMode}`;

    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";

    if (!state.activeFile){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Velg en aktiv fil i dropdown eller klikk p√• en fil i listen.</td></tr>`;
      return;
    }

    const wf = state.workflow;
    if (!wf){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Ingen workflow funnet. Klikk ‚ÄúStart ny workflow (aktiv fil)‚Äù eller ‚ÄúStart kontroll (alle)‚Äù.</td></tr>`;
      return;
    }

    for (const s of STEPS){
      const step = wf.steps[s.key];
      const tr = document.createElement("tr");
      const bcf = step?.bcfLink ? `<div class="muted">BCF: ${escapeHtml(step.bcfLink)}</div>` : "";
      tr.innerHTML = `
        <td>${s.label}</td>
        <td>${step ? statusTag(step.result) : `<span class="tag">Ikke signert</span>`}</td>
        <td>${step ? escapeHtml(step.by || "‚Äì") : "‚Äì"}</td>
        <td>${step ? escapeHtml(step.at || "‚Äì") : "‚Äì"}</td>
        <td>${step ? escapeHtml(step.comment || "") : ""} ${bcf}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ---------- 3D helpers ----------

  function viewerAvailable(){
    return !!(API?.viewer);
  }

  async function setScopeFromLoadedModels3D(){
    if (!viewerAvailable()) {
      alert("Viewer API er ikke tilgjengelig. S√∏rg for at extensionen er installert som type=viewer og √•pnet i 3D.");
      return;
    }

    if (!API.viewer.getModels || !API.viewer.getLoadedModel){
      alert("Viewer API mangler getModels/getLoadedModel i dette milj√∏et.");
      return;
    }

    const models = await API.viewer.getModels();
    const loaded = (models || []).filter(m => {
      const s = (m.state || "").toString().toLowerCase();
      return s.includes("load") || m.isLoaded === true;
    });

    const files = [];
    for (const m of loaded){
      try{
        const f = await API.viewer.getLoadedModel(m.id);
        if (f?.id){
          files.push({
            id: f.id,
            name: f.name || m.name || "Ukjent modell",
            versionId: f.versionId || f.versionID || m.versionId || m.versionID || null
          });
        }
      }catch(e){}
    }

    if (!files.length){
      alert("Fant ingen lastede modeller i 3D akkurat n√•. Last inn modeller f√∏rst.");
      return;
    }
    setSelectedFiles(files);
  }

  async function setScopeFrom3DSelection(){
    if (!viewerAvailable()) {
      alert("Viewer API er ikke tilgjengelig. √Öpne extension i 3D viewer.");
      return;
    }

    // Best-effort: hent selection via event-data hvis vi har det, ellers pr√∏v via API hvis st√∏ttet
    let sel = null;

    try{
      if (API.viewer.getSelection){
        sel = await API.viewer.getSelection();
      }
    }catch(e){}

    // sel kan v√¶re [] eller et objekt; vi h√•ndterer begge
    const list = sel?.data || sel || [];
    if (!Array.isArray(list) || !list.length){
      alert("Ingen objekter valgt i 3D. Klikk et objekt i modellen f√∏rst.");
      return;
    }

    const modelIds = [...new Set(list.map(x => x.modelId).filter(Boolean))];
    const files = [];

    for (const mid of modelIds){
      try{
        const f = await API.viewer.getLoadedModel(mid);
        if (f?.id){
          files.push({
            id: f.id,
            name: f.name || f.fileName || "Ukjent modell",
            versionId: f.versionId || f.versionID || null
          });
        }
      }catch(e){}
    }

    if (!files.length){
      alert("Kunne ikke mappe 3D-valg til lastet modellfil. Pr√∏v ‚ÄúBruk lastede modeller (3D)‚Äù.");
      return;
    }

    setSelectedFiles(files);
  }

  async function handleViewerSelectionEvent(data){
    // data kan v√¶re {data:[{modelId,objectRuntimeIds...},...]} eller direkte array
    const list = data?.data || data || [];
    if (!Array.isArray(list) || !list.length) return;

    if (!viewerAvailable() || !API.viewer.getLoadedModel) return;

    const modelIds = [...new Set(list.map(x => x.modelId).filter(Boolean))];
    const files = [];

    for (const mid of modelIds){
      try{
        const f = await API.viewer.getLoadedModel(mid);
        if (f?.id){
          files.push({
            id: f.id,
            name: f.name || f.fileName || "Ukjent modell",
            versionId: f.versionId || f.versionID || null
          });
        }
      }catch(e){}
    }

    if (files.length) setSelectedFiles(files);
  }

  // ---------- Release packages + PDF ----------

  function buildReleasePackageFor(fileObj){
    const key = buildStorageKey(state.project?.id ?? "noProject", fileObj.id, fileObj.versionId);
    const wf = loadWorkflow(key);

    if (!wf){
      return {
        schema: "deliverygate-release-package-v4",
        generatedAt: nowISO(),
        generatedBy: safeUserDisplay(state.user),
        releaseReady: false,
        issues: ["Ingen workflow funnet"],
        workflow: null,
        fileMeta: { name: fileObj.name, fileId: fileObj.id, versionId: fileObj.versionId || null }
      };
    }

    const ready =
      !!wf.steps.egenkontroll &&
      !!wf.steps.sidemann &&
      !!wf.steps.kollisjon &&
      !!wf.steps.godkjenning &&
      isOk(wf.steps.kollisjon);

    const issues = [];
    for (const s of STEPS){
      const step = wf.steps[s.key];
      if (!step) issues.push(`${s.label}: mangler signering`);
      else if (step.result === "IKKE_OK") issues.push(`${s.label}: IKKE OK (BCF: ${step.bcfLink || "mangler"})`);
    }

    return {
      schema: "deliverygate-release-package-v4",
      generatedAt: nowISO(),
      generatedBy: safeUserDisplay(state.user),
      releaseReady: ready,
      issues,
      workflow: wf
    };
  }

  function generatePdfReportForActive(){
    if (!state.activeFile) return alert("Velg aktiv fil f√∏rst.");
    const pkg = buildReleasePackageFor(state.activeFile);
    const wf = pkg.workflow;
    if (!wf) return alert("Ingen workflow for aktiv fil.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const margin = 40;
    let y = margin;

    const line = (txt, size=11, bold=false) => {
      doc.setFont("helvetica", bold ? "bold" : "normal");
      doc.setFontSize(size);
      const width = 595 - margin*2;
      const lines = doc.splitTextToSize(txt, width);
      for (const l of lines){
        if (y > 842 - margin){ doc.addPage(); y = margin; }
        doc.text(l, margin, y);
        y += size + 6;
      }
    };

    line("DeliveryGate ‚Äì QA-rapport", 16, true);
    line(`Generert: ${pkg.generatedAt}`, 10);
    line(`Generert av: ${pkg.generatedBy}`, 10);
    y += 6;

    line("Dokument", 12, true);
    line(`Prosjekt: ${wf.fileMeta.projectName} (${wf.fileMeta.projectId})`, 11);
    line(`Fil: ${wf.fileMeta.name}`, 11);
    line(`Fil-ID: ${wf.fileMeta.fileId}`, 10);
    line(`Versjon-ID: ${wf.fileMeta.versionId || "‚Äì"}`, 10);
    y += 6;

    line("Status", 12, true);
    line(`Release-ready: ${pkg.releaseReady ? "JA" : "NEI"}`, 11, true);
    if (pkg.issues?.length){
      line("Avvik / mangler:", 11, true);
      for (const it of pkg.issues){ line(`- ${it}`, 10); }
    } else {
      line("Ingen registrerte avvik.", 10);
    }
    y += 6;

    line("Stegvis signering", 12, true);
    for (const s of STEPS){
      const step = wf.steps[s.key];
      line(`${s.label}:`, 11, true);
      if (!step){
        line("Ikke signert", 10);
      } else {
        line(`Resultat: ${step.result}`, 10);
        line(`Utf√∏rt av: ${step.by}`, 10);
        line(`Tidspunkt: ${step.at}`, 10);
        if (step.comment) line(`Kommentar: ${step.comment}`, 10);
        if (step.bcfLink) line(`BCF: ${step.bcfLink}`, 10);
      }
      y += 4;
    }

    const fname = `DeliveryGate_QA-rapport_${wf.fileMeta.name}_${wf.fileMeta.versionId || "noVersion"}.pdf`;
    doc.save(fname.replace(/[^\w.\-() ]+/g, "_"));
  }

  // ---------- Init ----------

  async function init(){
    API = await TrimbleConnectWorkspace.connect(window.parent, async (event, data) => {
      // Explorer events (kan forekomme hvis du √•pner extension fra project-siden)
      const explorerEvents = [
        "extension.filesSelected",
        "extension.selectionChanged",
        "extension.fileSelected",
        "extension.fileViewClicked"
      ];

      // Viewer events (navn kan variere litt mellom UI-versjoner, s√• vi lytter p√• flere)
      const viewerEvents = [
        "viewer.onSelectionChanged",
        "viewer.selectionChanged",
        "viewer.onSelection"
      ];

      if (viewerEvents.includes(event)){
        state.runtimeMode = "viewer";
        await handleViewerSelectionEvent(data);
        renderActive();
        return;
      }

      if (explorerEvents.includes(event)){
        state.runtimeMode = "project";
        // vi ignorerer dette for din use-case, men lar det st√• (kan v√¶re nyttig)
        // const sel = normalizeIncomingSelection(data);
        // if (sel.length) setSelectedFiles(sel);
        renderActive();
        return;
      }
    });

    state.project = await API.project.getProject();
    state.user = await API.user.getUser();

    // Bestem runtime-mode basert p√• tilgjengelig API
    state.runtimeMode = viewerAvailable() ? "viewer" : "project";

    document.getElementById("activeFileSelect").addEventListener("change", onActiveChanged);
    document.getElementById("result").addEventListener("change", toggleBcfUI);
    toggleBcfUI();

    document.getElementById("btnUseLoaded3D").addEventListener("click", async () => {
      try{
        await setScopeFromLoadedModels3D();
      }catch(e){
        console.error(e);
        alert("Feil ved henting av lastede modeller. Sjekk console.");
      }
    });

    document.getElementById("btnUse3DSelection").addEventListener("click", async () => {
      try{
        await setScopeFrom3DSelection();
      }catch(e){
        console.error(e);
        alert("Feil ved henting av 3D-valg. Sjekk console.");
      }
    });

    document.getElementById("btnStartForAll").addEventListener("click", () => {
      if (!state.selectedFiles.length){
        alert("Ingen filer i scope. Trykk ‚ÄúBruk lastede modeller (3D)‚Äù f√∏rst.");
        return;
      }
      for (const f of state.selectedFiles){
        const key = buildStorageKey(state.project.id, f.id, f.versionId);
        if (!loadWorkflow(key)) saveWorkflow(key, newWorkflowFor(f));
      }
      onActiveChanged();
      renderFileList();
      alert("Workflow opprettet for alle filer i scope (der det ikke fantes fra f√∏r).");
    });

    document.getElementById("btnNewActive").addEventListener("click", () => {
      if (!state.activeFile) return alert("Velg aktiv fil f√∏rst.");
      const key = buildStorageKey(state.project.id, state.activeFile.id, state.activeFile.versionId);
      saveWorkflow(key, newWorkflowFor(state.activeFile));
      state.workflow = loadWorkflow(key);
      clearRuleError();
      renderActive();
      renderFileList();
    });

    document.getElementById("btnExportActive").addEventListener("click", () => {
      if (!state.activeFile) return alert("Velg aktiv fil f√∏rst.");
      const key = buildStorageKey(state.project.id, state.activeFile.id, state.activeFile.versionId);
      const wf = loadWorkflow(key);
      if (!wf) return alert("Ingen workflow √• eksportere for aktiv fil.");
      downloadText(`DeliveryGate_workflow_${state.activeFile.name}.json`, JSON.stringify(wf, null, 2));
    });

    document.getElementById("btnClearActive").addEventListener("click", () => {
      if (!state.activeFile) return alert("Velg aktiv fil f√∏rst.");
      const key = buildStorageKey(state.project.id, state.activeFile.id, state.activeFile.versionId);
      if (!confirm("Slette workflow for aktiv fil?")) return;
      localStorage.removeItem(key);
      state.workflow = null;
      clearRuleError();
      renderActive();
      renderFileList();
    });

    document.getElementById("btnSign").addEventListener("click", () => {
      clearRuleError();
      if (!state.activeFile) return alert("Velg aktiv fil f√∏rst.");

      const key = buildStorageKey(state.project.id, state.activeFile.id, state.activeFile.versionId);
      let wf = loadWorkflow(key);
      if (!wf){
        if (!confirm("Ingen workflow funnet. Opprette ny n√•?")) return;
        wf = newWorkflowFor(state.activeFile);
      }
      state.workflow = wf;

      const stepKey = document.getElementById("step").value;
      const result = document.getElementById("result").value;
      const comment = document.getElementById("comment").value.trim();
      const bcfLink = document.getElementById("bcfLink").value.trim();
      const stepLabel = STEPS.find(x => x.key === stepKey)?.label ?? stepKey;

      const ruleErr = validateRules(stepKey, result, bcfLink);
      if (ruleErr){ showRuleError(ruleErr); return; }

      const signed = {
        stepKey, stepLabel, result, comment,
        bcfLink: (result === "IKKE_OK") ? bcfLink : "",
        at: nowISO(),
        by: safeUserDisplay(state.user)
      };

      wf.steps[stepKey] = signed;
      wf.history = wf.history || [];
      wf.history.push(signed);

      saveWorkflow(key, wf);
      state.workflow = wf;

      document.getElementById("comment").value = "";
      document.getElementById("bcfLink").value = "";
      toggleBcfUI();

      renderActive();
      renderFileList();
    });

    document.getElementById("btnReportJsonAll").addEventListener("click", () => {
      if (!state.selectedFiles.length) return alert("Ingen filer i scope.");
      const items = state.selectedFiles.map(f => buildReleasePackageFor(f));
      const bundle = {
        schema: "deliverygate-release-bundle-v2",
        project: { id: state.project.id, name: state.project.name },
        generatedAt: nowISO(),
        generatedBy: safeUserDisplay(state.user),
        items
      };
      downloadText(`DeliveryGate_release-bundle_${state.project.name}.json`, JSON.stringify(bundle, null, 2));
    });

    document.getElementById("btnReportPdfActive").addEventListener("click", generatePdfReportForActive);

    document.getElementById("btnToken").addEventListener("click", async () => {
      try{
        state.accessToken = await API.extension.requestPermission("accesstoken");
        const el = document.getElementById("tokenInfo");
        el.style.display = "block";
        el.textContent = state.accessToken ? "AccessToken hentet (skjult). Klar for backend-kall." : "Ingen token mottatt.";
      }catch(e){
        alert("Kunne ikke hente token. Sjekk extension permissions.");
      }
    });

    // Auto: hvis vi er i viewer, pr√∏v √• hente lastede modeller ved oppstart (best-effort)
    renderActive();
    renderFileList();

    if (state.runtimeMode === "viewer"){
      try{
        await setScopeFromLoadedModels3D();
      }catch(e){
        // Ikke spamme med alerts her; bruker kan trykke knappen
        console.warn("Auto-hent lastede modeller feilet:", e);
      }
    }
  }

  init().catch(err => {
    console.error(err);
    alert("Kunne ikke starte DeliveryGate. Se console for detaljer.");
  });
</script>
</body>
</html>
