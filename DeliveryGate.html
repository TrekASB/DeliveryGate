<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeliveryGate</title>

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- jsPDF for PDF-rapport -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --bg:#ffffff; --bg2:#f9fafb; }
    body { font-family: system-ui, Segoe UI, Arial; margin:0; color:var(--t); background:var(--bg); }
    header { padding:14px 18px; border-bottom:1px solid var(--b); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:16px; margin:0; }
    header .pill { font-size:12px; color:var(--m); background:var(--bg2); border:1px solid var(--b); padding:4px 8px; border-radius:999px; }

    .brand { display:flex; align-items:center; gap:10px; margin-right:6px; }
    .brand img { height:22px; width:auto; display:block; }
    .brand .title { display:flex; flex-direction:column; line-height:1.1; }
    .brand .title b { font-size:14px; }
    .brand .title span { font-size:12px; color:var(--m); }

    main { padding:16px 18px; display:grid; gap:16px; grid-template-columns: 1.2fr 0.8fr; }
    @media (max-width: 1000px){ main{ grid-template-columns:1fr; } }

    .card { border:1px solid var(--b); border-radius:12px; overflow:hidden; background:#fff; }
    .card h2 { font-size:14px; margin:0; padding:12px 14px; border-bottom:1px solid var(--b); background:var(--bg2); }
    .card .content { padding:14px; display:grid; gap:12px; }

    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; font-size:13px; }
    .kv div:nth-child(odd){ color:var(--m); }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:var(--m); display:block; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:10px; border:1px solid var(--b); border-radius:10px; font-size:13px; }
    textarea { min-height:88px; resize:vertical; }
    .btn { padding:10px 12px; border:1px solid var(--b); border-radius:10px; background:var(--bg2); cursor:pointer; font-size:13px; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn.danger { background:#fff; border-color:#ef4444; color:#b91c1c; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--b); vertical-align:top; }
    th { text-align:left; color:var(--m); font-weight:600; font-size:12px; }

    .tag { display:inline-block; font-size:12px; padding:2px 8px; border:1px solid var(--b); border-radius:999px; background:var(--bg2); margin-right:6px; }
    .ok { border-color:#10b98155; background:#10b98115; }
    .no { border-color:#ef444455; background:#ef444415; }
    .na { border-color:#f59e0b55; background:#f59e0b15; }
    .muted { color:var(--m); font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .warn { border:1px solid #f59e0b55; background:#f59e0b10; padding:10px; border-radius:10px; font-size:12px; color:#92400e; }
    .err { border:1px solid #ef444455; background:#ef444410; padding:10px; border-radius:10px; font-size:12px; color:#991b1b; }
    a { color: inherit; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img src="./norconsult-logo-black.png" alt="Norconsult" />
    <div class="title">
      <b>DeliveryGate</b>
      <span>Document Workflow / QA</span>
    </div>
  </div>

  <span class="pill" id="pillProject">Prosjekt: –</span>
  <span class="pill" id="pillUser">Bruker: –</span>
  <span class="pill" id="pillFile">Fil: (velg en fil)</span>
</header>

<main>
  <section class="card">
    <h2>Workflow-logg (per fil + versjon)</h2>
    <div class="content">
      <div class="row">
        <button class="btn" id="btnNew">Start ny workflow for valgt fil/versjon</button>
        <button class="btn" id="btnExport">Eksporter JSON</button>
        <button class="btn" id="btnImport">Importer JSON</button>
        <button class="btn" id="btnReportPdf">QA-rapport PDF</button>
        <button class="btn" id="btnReportJson">Release-ready JSON-pakke</button>
        <button class="btn danger" id="btnClear">Slett workflow (kun denne fil/versjon)</button>
      </div>

      <div class="warn">
        <b>Regelsett:</b>
        <ul style="margin:6px 0 0 16px; padding:0;">
          <li>Sidemannskontroll kan ikke signeres av samme person som signerte egenkontroll.</li>
          <li>Godkjenning kan ikke signeres før kollisjonskontroll er <b>OK</b>.</li>
          <li>Ved <b>IKKE OK</b> må du legge inn BCF Topic-lenke/ID.</li>
        </ul>
      </div>

      <div id="noFile" class="muted">
        Velg en fil i Trimble Connect File Explorer. Extension lytter på <span class="mono">extension.fileSelected</span>.
      </div>

      <div id="logWrap" style="display:none">
        <div class="muted">
          Nøkkel: <span class="mono" id="keyLabel">–</span>
        </div>

        <table>
          <thead>
            <tr>
              <th>Steg</th>
              <th>Status</th>
              <th>Utført av</th>
              <th>Tidspunkt</th>
              <th>Kommentar</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <aside class="card">
    <h2>Registrer kontroll</h2>
    <div class="content">
      <div class="kv">
        <div>Filnavn</div><div id="metaName">–</div>
        <div>Fil-ID</div><div class="mono" id="metaId">–</div>
        <div>Versjon-ID</div><div class="mono" id="metaVer">–</div>
      </div>

      <div class="row" style="width:100%">
        <div style="flex:1; min-width:220px">
          <label for="step">Steg</label>
          <select id="step">
            <option value="egenkontroll">Egenkontroll</option>
            <option value="sidemann">Sidemannskontroll</option>
            <option value="kollisjon">Kollisjonskontroll</option>
            <option value="godkjenning">Godkjenning</option>
          </select>
        </div>

        <div style="flex:1; min-width:220px">
          <label for="result">Resultat</label>
          <select id="result">
            <option value="OK">OK</option>
            <option value="IKKE_OK">IKKE OK</option>
            <option value="N/A">N/A</option>
          </select>
        </div>
      </div>

      <div id="bcfWrap" style="display:none">
        <label for="bcfLink">BCF Topic (påkrevd ved IKKE OK)</label>
        <input id="bcfLink" placeholder="Lim inn URL til topic, eller skriv Topic-ID (f.eks. BCF-1234)" />
        <div class="muted">Tips: bruk direkte lenke til topic i Trimble Connect / BCF-verktøyet dere bruker.</div>
      </div>

      <div>
        <label for="comment">Kommentar / funn</label>
        <textarea id="comment" placeholder="Kort beskrivelse av hva som er sjekket og eventuelle avvik..."></textarea>
      </div>

      <div id="ruleMsg" class="err" style="display:none"></div>

      <div class="row">
        <button class="btn primary" id="btnSign">Signér steg</button>
        <button class="btn" id="btnToken">Hent accessToken (valgfritt)</button>
      </div>

      <div class="muted" id="tokenInfo" style="display:none"></div>
    </div>
  </aside>
</main>

<script>
  let API = null;

  const state = {
    project: null,
    user: null,
    selectedFile: null,
    storageKey: null,
    workflow: null,
    accessToken: null
  };

  const STEPS = [
    { key: "egenkontroll", label: "Egenkontroll" },
    { key: "sidemann", label: "Sidemannskontroll" },
    { key: "kollisjon", label: "Kollisjonskontroll" },
    { key: "godkjenning", label: "Godkjenning" }
  ];

  function nowISO(){ return new Date().toISOString(); }

  function safeUserDisplay(u){
    if (!u) return "Ukjent";
    return u.name || u.displayName || u.email || u.userName || "Ukjent";
  }

  function buildStorageKey(projectId, fileId, versionId){
    return `deliverygate::${projectId}::${fileId}::${versionId || "noVersion"}`;
  }

  function loadWorkflow(key){
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }

  function saveWorkflow(key, wf){
    localStorage.setItem(key, JSON.stringify(wf));
  }

  function newWorkflowForSelected(){
    if (!state.project || !state.selectedFile) return null;
    return {
      schema: "deliverygate-workflow-v1",
      createdAt: nowISO(),
      createdBy: safeUserDisplay(state.user),
      fileMeta: {
        projectId: state.project.id,
        projectName: state.project.name,
        fileId: state.selectedFile.id,
        versionId: state.selectedFile.versionId || null,
        name: state.selectedFile.name
      },
      steps: { egenkontroll:null, sidemann:null, kollisjon:null, godkjenning:null },
      history: []
    };
  }

  function statusTag(result){
    if (result === "OK") return `<span class="tag ok">OK</span>`;
    if (result === "IKKE_OK") return `<span class="tag no">IKKE OK</span>`;
    return `<span class="tag na">N/A</span>`;
  }

  function showRuleError(msg){
    const el = document.getElementById("ruleMsg");
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearRuleError(){
    const el = document.getElementById("ruleMsg");
    el.style.display = "none";
    el.textContent = "";
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("`",""); }

  function downloadText(filename, text, mime="application/json"){
    const blob = new Blob([text], { type: mime });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename.replace(/[^\w.\-() ]+/g, "_");
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function isOk(stepObj){ return stepObj && stepObj.result === "OK"; }

  function validateRules(stepKey, result, bcfLink){
    if (result === "IKKE_OK" && (!bcfLink || !bcfLink.trim())){
      return "Resultat = IKKE OK krever BCF Topic-lenke/ID.";
    }

    const wf = state.workflow;
    const currentUser = safeUserDisplay(state.user);

    if (stepKey === "sidemann"){
      const egen = wf?.steps?.egenkontroll;
      if (egen?.by && egen.by === currentUser){
        return "Regelbrudd: Sidemannskontroll kan ikke signeres av samme person som egenkontroll.";
      }
    }

    if (stepKey === "godkjenning"){
      const koll = wf?.steps?.kollisjon;
      if (!isOk(koll)){
        return "Regelbrudd: Godkjenning kan ikke signeres før Kollisjonskontroll = OK.";
      }
    }
    return null;
  }

  function buildReleasePackage(){
    const wf = state.workflow;
    if (!wf) return null;

    const ready =
      !!wf.steps.egenkontroll &&
      !!wf.steps.sidemann &&
      !!wf.steps.kollisjon &&
      !!wf.steps.godkjenning &&
      isOk(wf.steps.kollisjon);

    const issues = [];
    for (const s of STEPS){
      const step = wf.steps[s.key];
      if (!step) issues.push(`${s.label}: mangler signering`);
      else if (step.result === "IKKE_OK"){
        issues.push(`${s.label}: IKKE OK (BCF: ${step.bcfLink || "mangler"})`);
      }
    }

    return {
      schema: "deliverygate-release-package-v1",
      generatedAt: nowISO(),
      generatedBy: safeUserDisplay(state.user),
      releaseReady: ready,
      issues,
      workflow: wf
    };
  }

  function generatePdfReport(pkg){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const margin = 40;
    let y = margin;

    const line = (txt, size=11, bold=false) => {
      doc.setFont("helvetica", bold ? "bold" : "normal");
      doc.setFontSize(size);
      const width = 595 - margin*2;
      const lines = doc.splitTextToSize(txt, width);
      for (const l of lines){
        if (y > 842 - margin){
          doc.addPage();
          y = margin;
        }
        doc.text(l, margin, y);
        y += size + 6;
      }
    };

    const wf = pkg.workflow;
    line("DeliveryGate – QA-rapport", 16, true);
    line(`Generert: ${pkg.generatedAt}`, 10);
    line(`Generert av: ${pkg.generatedBy}`, 10);
    y += 6;

    line("Dokument", 12, true);
    line(`Prosjekt: ${wf.fileMeta.projectName} (${wf.fileMeta.projectId})`, 11);
    line(`Fil: ${wf.fileMeta.name}`, 11);
    line(`Fil-ID: ${wf.fileMeta.fileId}`, 10);
    line(`Versjon-ID: ${wf.fileMeta.versionId || "–"}`, 10);
    y += 6;

    line("Status", 12, true);
    line(`Release-ready: ${pkg.releaseReady ? "JA" : "NEI"}`, 11, true);
    if (pkg.issues?.length){
      line("Avvik / mangler:", 11, true);
      for (const it of pkg.issues){
        line(`- ${it}`, 10);
      }
    } else {
      line("Ingen registrerte avvik.", 10);
    }
    y += 6;

    line("Stegvis signering", 12, true);
    for (const s of STEPS){
      const step = wf.steps[s.key];
      line(`${s.label}:`, 11, true);
      if (!step){
        line("Ikke signert", 10);
      } else {
        line(`Resultat: ${step.result}`, 10);
        line(`Utført av: ${step.by}`, 10);
        line(`Tidspunkt: ${step.at}`, 10);
        if (step.comment) line(`Kommentar: ${step.comment}`, 10);
        if (step.bcfLink) line(`BCF: ${step.bcfLink}`, 10);
      }
      y += 4;
    }

    y += 6;
    line("Historikk", 12, true);
    const hist = wf.history || [];
    if (!hist.length){
      line("Ingen historikk.", 10);
    } else {
      for (const h of hist){
        line(`- ${h.at} | ${h.stepLabel} | ${h.result} | ${h.by}`, 9);
        if (h.comment) line(`  Kommentar: ${h.comment}`, 9);
        if (h.bcfLink) line(`  BCF: ${h.bcfLink}`, 9);
      }
    }

    const fname = `DeliveryGate_QA-rapport_${wf.fileMeta.name}_${wf.fileMeta.versionId || "noVersion"}.pdf`;
    doc.save(fname.replace(/[^\w.\-() ]+/g, "_"));
  }

  function toggleBcfUI(){
    const res = document.getElementById("result").value;
    document.getElementById("bcfWrap").style.display = (res === "IKKE_OK") ? "block" : "none";
  }

  function render(){
    document.getElementById("pillProject").textContent = `Prosjekt: ${state.project?.name ?? "–"}`;
    document.getElementById("pillUser").textContent = `Bruker: ${safeUserDisplay(state.user)}`;

    const hasFile = !!state.selectedFile;
    document.getElementById("noFile").style.display = hasFile ? "none" : "block";
    document.getElementById("logWrap").style.display = hasFile ? "block" : "none";
    document.getElementById("pillFile").textContent = hasFile ? `Fil: ${state.selectedFile.name}` : "Fil: (velg en fil)";

    document.getElementById("metaName").textContent = hasFile ? state.selectedFile.name : "–";
    document.getElementById("metaId").textContent = hasFile ? (state.selectedFile.id || "–") : "–";
    document.getElementById("metaVer").textContent = hasFile ? (state.selectedFile.versionId || "–") : "–";
    document.getElementById("keyLabel").textContent = state.storageKey || "–";

    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";

    if (!hasFile) return;

    const wf = state.workflow;
    if (!wf){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Ingen workflow funnet. Klikk "Start ny workflow".</td></tr>`;
      return;
    }

    for (const s of STEPS){
      const step = wf.steps[s.key];
      const tr = document.createElement("tr");
      const comment = step?.comment || "";
      const bcf = step?.bcfLink ? `<div class="muted">BCF: <a href="${escapeAttr(step.bcfLink)}" target="_blank">${escapeHtml(step.bcfLink)}</a></div>` : "";
      tr.innerHTML = `
        <td>${s.label}</td>
        <td>${step ? statusTag(step.result) : `<span class="tag">Ikke signert</span>`}</td>
        <td>${step ? escapeHtml(step.by || "–") : "–"}</td>
        <td>${step ? escapeHtml(step.at || "–") : "–"}</td>
        <td>${escapeHtml(comment)} ${bcf}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function init(){
    API = await TrimbleConnectWorkspace.connect(window.parent, async (event, data) => {
      if (event === "extension.fileSelected" || event === "extension.fileViewClicked") {
        const f = data?.file ?? data;
        if (f?.id){
          state.selectedFile = {
            id: f.id,
            name: f.name || f.fileName || "Ukjent fil",
            versionId: f.versionId || f.versionID || null
          };
          state.storageKey = buildStorageKey(state.project?.id ?? "noProject", state.selectedFile.id, state.selectedFile.versionId);
          state.workflow = loadWorkflow(state.storageKey);
          clearRuleError();
          render();
        }
      }
    });

    state.project = await API.project.getProject();
    state.user = await API.user.getUser();
    render();

    document.getElementById("result").addEventListener("change", toggleBcfUI);
    toggleBcfUI();

    document.getElementById("btnNew").addEventListener("click", () => {
      if (!state.selectedFile) return alert("Velg en fil først.");
      state.workflow = newWorkflowForSelected();
      saveWorkflow(state.storageKey, state.workflow);
      clearRuleError();
      render();
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      if (!state.storageKey) return;
      if (!confirm("Slette workflow for denne fil/versjon?")) return;
      localStorage.removeItem(state.storageKey);
      state.workflow = null;
      clearRuleError();
      render();
    });

    document.getElementById("btnSign").addEventListener("click", () => {
      clearRuleError();
      if (!state.selectedFile) return alert("Velg en fil først.");

      if (!state.workflow){
        if (!confirm("Ingen workflow funnet. Opprette ny nå?")) return;
        state.workflow = newWorkflowForSelected();
      }

      const stepKey = document.getElementById("step").value;
      const result = document.getElementById("result").value;
      const comment = document.getElementById("comment").value.trim();
      const bcfLink = document.getElementById("bcfLink").value.trim();
      const stepLabel = STEPS.find(x => x.key === stepKey)?.label ?? stepKey;

      const ruleErr = validateRules(stepKey, result, bcfLink);
      if (ruleErr){ showRuleError(ruleErr); return; }

      const signed = {
        stepKey,
        stepLabel,
        result,
        comment,
        bcfLink: (result === "IKKE_OK") ? bcfLink : "",
        at: nowISO(),
        by: safeUserDisplay(state.user)
      };

      state.workflow.steps[stepKey] = signed;
      state.workflow.history = state.workflow.history || [];
      state.workflow.history.push(signed);

      saveWorkflow(state.storageKey, state.workflow);

      document.getElementById("comment").value = "";
      document.getElementById("bcfLink").value = "";
      toggleBcfUI();
      render();
    });

    document.getElementById("btnExport").addEventListener("click", () => {
      if (!state.workflow) return alert("Ingen workflow å eksportere.");
      downloadText(`DeliveryGate_workflow_${state.selectedFile?.name || "file"}.json`, JSON.stringify(state.workflow, null, 2));
    });

    document.getElementById("btnImport").addEventListener("click", async () => {
      if (!state.selectedFile) return alert("Velg en fil først.");
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj?.schema?.startsWith("deliverygate-")) return alert("Ugyldig fil (schema mismatch).");
        state.workflow = obj;
        saveWorkflow(state.storageKey, state.workflow);
        clearRuleError();
        render();
      };
      inp.click();
    });

    document.getElementById("btnReportJson").addEventListener("click", () => {
      if (!state.workflow) return alert("Ingen workflow å rapportere.");
      const pkg = buildReleasePackage();
      downloadText(
        `DeliveryGate_release-package_${state.selectedFile?.name || "file"}_${state.selectedFile?.versionId || "noVersion"}.json`,
        JSON.stringify(pkg, null, 2)
      );
    });

    document.getElementById("btnReportPdf").addEventListener("click", () => {
      if (!state.workflow) return alert("Ingen workflow å rapportere.");
      generatePdfReport(buildReleasePackage());
    });

    document.getElementById("btnToken").addEventListener("click", async () => {
      try{
        state.accessToken = await API.extension.requestPermission("accesstoken");
        const el = document.getElementById("tokenInfo");
        el.style.display = "block";
        el.textContent = state.accessToken ? "AccessToken hentet (skjult). Klar for backend-kall." : "Ingen token mottatt.";
      }catch(e){
        alert("Kunne ikke hente token. Sjekk extension permissions.");
      }
    });
  }

  init().catch(err => {
    console.error(err);
    alert("Kunne ikke starte DeliveryGate. Se console for detaljer.");
  });
</script>
</body>
</html>
